<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>预约演示 · KidneySphere AI</title>
  <link rel="stylesheet" href="/app.css"/>
  <link rel="icon" href="/assets/kidneysphere-ai.png"/>
  <script src="/config.js"></script>
  <style>
    .demo-success{display:none;text-align:center;padding:32px 20px;}
    .demo-success .icon{font-size:48px;margin-bottom:12px;}
    .demo-success h2{margin:0 0 8px;}
    .tag-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
    .tag{display:inline-block;font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid rgba(15,23,42,.12);background:rgba(2,6,23,.02);cursor:pointer;user-select:none;}
    .tag.sel{border-color:rgba(37,99,235,.45);background:rgba(37,99,235,.08);color:#1d4ed8;}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="brand">
        <img src="/assets/kidneysphere-ai.png" alt="KidneySphere AI"/>
        <div>
          <h1 class="brand-title">预约演示 · KidneySphere AI</h1>
          <div class="brand-sub">填写后我们将在 1 个工作日内通过邮件或微信联系您，安排在线演示。</div>
        </div>
      </div>

      <div class="btnbar" style="margin-top:12px">
        <a class="btn" href="/">返回首页</a>
        <a class="btn" href="/guide">使用说明</a>
        <a class="btn" href="/slides">系统介绍PPT</a>
        <a class="btn" href="/pricing">价格方案</a>
      </div>

      <div class="hr"></div>

      <!-- Form -->
      <form id="demoForm" autocomplete="on">
        <div class="row">
          <div class="col">
            <label>您的姓名 <span style="color:#dc2626">*</span></label>
            <input id="f_name" type="text" placeholder="王医生 / 张老师" required autocomplete="name"/>
          </div>
          <div class="col">
            <label>所在机构 / 医院 <span style="color:#dc2626">*</span></label>
            <input id="f_institution" type="text" placeholder="北京协和医院 / 上海交大附属仁济医院" required/>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>科室 / 职位</label>
            <input id="f_department" type="text" placeholder="肾内科 PI / 研究生 / 数据管理员"/>
          </div>
          <div class="col">
            <label>联系邮箱 <span style="color:#dc2626">*</span></label>
            <input id="f_email" type="email" placeholder="your@email.com" required autocomplete="email"/>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>微信号 / 手机（选填，方便约时间）</label>
            <input id="f_contact" type="text" placeholder="微信号 或 13x-xxxx-xxxx"/>
          </div>
        </div>

        <label style="margin-top:14px;display:block;font-size:12px;color:#64748b">
          您的主要病种 / 使用场景（可多选）
        </label>
        <div class="tag-row" id="tagRow">
          <span class="tag" data-val="IGAN">IgA 肾病</span>
          <span class="tag" data-val="LN">狼疮性肾炎</span>
          <span class="tag" data-val="MN">膜性肾病</span>
          <span class="tag" data-val="KTX">肾移植</span>
          <span class="tag" data-val="GENERAL">通用 / 其他肾病</span>
          <span class="tag" data-val="MULTICENTER">多中心合并</span>
          <span class="tag" data-val="PILOT">科室数据库建设</span>
        </div>

        <label style="margin-top:14px;display:block;font-size:12px;color:#64748b">补充说明 / 您最想了解的功能</label>
        <textarea id="f_message" placeholder="例如：我们是 3 个中心的 IgAN 队列，约 200 例，想了解多中心合并与论文包功能..." rows="4"></textarea>

        <div id="formErr" class="warnbox" style="display:none;margin-top:10px"></div>

        <div class="btnbar" style="margin-top:14px">
          <button class="btn primary" type="submit" id="btnSubmit">提交预约申请</button>
        </div>
      </form>

      <!-- Success state -->
      <div class="demo-success" id="demoSuccess">
        <div class="icon">✅</div>
        <h2>预约成功！</h2>
        <p class="small">我们已收到您的申请，将在 <b>1 个工作日内</b>通过邮件或微信联系您安排演示。<br/>如需加急，请直接发邮件至 <a href="mailto:bd@kidneysphere.ai">bd@kidneysphere.ai</a>。</p>
        <div class="btnbar" style="justify-content:center;margin-top:16px">
          <a class="btn primary" href="/guide">先看使用说明</a>
          <a class="btn" href="/slides">看系统介绍PPT</a>
          <a class="btn" href="/">返回首页</a>
        </div>
      </div>

      <div class="hr"></div>

      <div class="kv" style="margin-top:8px">
        <div>演示时长</div><div>约 30 分钟（含 Q&amp;A）</div>
        <div>演示形式</div><div>腾讯会议 / 飞书 / Zoom（按您偏好）</div>
        <div>演示内容</div><div>后台录入演示 + 一键生成论文包 + 多中心合并 + 定价方案</div>
        <div>适合人群</div><div>PI / 研究生 / 数据管理员 / 医院科研管理人员</div>
      </div>

      <div class="infobox" style="margin-top:12px">
        也可以直接发邮件：<a href="mailto:bd@kidneysphere.ai">bd@kidneysphere.ai</a>，注明"预约演示"。
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // Tag multi-select
    const tagRow = document.getElementById('tagRow');
    tagRow.addEventListener('click', e => {
      const t = e.target.closest('.tag');
      if (t) t.classList.toggle('sel');
    });

    function selectedTags() {
      return [...tagRow.querySelectorAll('.tag.sel')].map(t => t.dataset.val).join(',');
    }

    // Form submit
    const form = document.getElementById('demoForm');
    const btnSubmit = document.getElementById('btnSubmit');
    const formErr = document.getElementById('formErr');

    form.addEventListener('submit', async e => {
      e.preventDefault();
      formErr.style.display = 'none';
      btnSubmit.disabled = true;
      btnSubmit.textContent = '提交中…';

      const cfg = window.CONFIG || {};
      let sbClient;
      try {
        sbClient = createClient(cfg.SUPABASE_URL, cfg.SUPABASE_ANON_KEY);
      } catch {
        showErr('Supabase 未配置，请联系管理员或直接发邮件至 bd@kidneysphere.ai');
        reset();
        return;
      }

      const payload = {
        name:        document.getElementById('f_name').value.trim(),
        institution: document.getElementById('f_institution').value.trim(),
        department:  document.getElementById('f_department').value.trim() || null,
        email:       document.getElementById('f_email').value.trim(),
        contact:     document.getElementById('f_contact').value.trim() || null,
        use_case:    selectedTags() || null,
        message:     document.getElementById('f_message').value.trim() || null,
      };

      const { error } = await sbClient.from('demo_requests').insert(payload);

      if (error) {
        showErr('提交失败：' + error.message + '。请直接发邮件至 bd@kidneysphere.ai');
        reset();
      } else {
        form.style.display = 'none';
        document.getElementById('demoSuccess').style.display = 'block';
      }
    });

    function showErr(msg) {
      formErr.textContent = msg;
      formErr.style.display = 'block';
    }
    function reset() {
      btnSubmit.disabled = false;
      btnSubmit.textContent = '提交预约申请';
    }
  </script>
</body>
</html>
