# KidneySphere AI 随访登记系统详细使用说明（培训版）

> 适用对象：项目负责人（PI）、研究协调员（CRC）、录入员、随访护士。  
> 系统定位：科研随访登记（Research Registry），**不是**临床诊断/治疗决策系统。  
> 合规红线：**严禁录入任何可识别个人信息（PII）**，例如姓名、手机号、身份证号、住院号。

---

## 1. 你要先理解的 3 个核心概念

在开始操作之前，先讲清楚三个概念，培训会更顺利。

### 1.1 角色与入口

系统主要有两个入口：

1. **管理端 `/staff`**（需要邮箱魔法链接登录）
   - 用于：创建项目、录入基线、生成随访链接、导出论文包、生成数据快照。
2. **随访填报端 `/p/<token>`**（无需登录）
   - 用于：现场随访人员按 token 链接填访视数据。

### 1.2 数据组织方式（你可以这样讲给用户）

- `project`（项目）= 一个研究队列容器。
- `patient_code`（受试者研究编号）= 每个中心内部唯一编号。
- `visit`（访视）= 某次随访记录（日期、血压、Scr、UPCR 等）。

### 1.3 多中心合并规则（重点）

最终合并键是：**`center_code + patient_code`**。  
也就是说：
- 北京中心 `BJ01` 的 `P0001` 和上海中心 `SH02` 的 `P0001` 不冲突。
- 但是同一个中心里，`patient_code` 不能重复。

---

## 2. 上线前准备（管理员一次性完成）

下面流程建议由技术管理员/项目管理员先完成，再培训普通用户。

## 2.1 创建 Supabase 项目

1. 登录 Supabase，点击 **New Project**。
2. 记录两个关键信息：
   - `Project URL`
   - `anon public key`

## 2.2 初始化数据库（必须）

在 Supabase 的 SQL Editor 运行：

- `supabase/migrations/0001_core.sql`

> 作用：创建核心表、RLS 策略、token 随访 RPC 等关键能力。

## 2.3 配置登录回调地址（避免“收到了邮件却登录失败”）

Supabase → Authentication → URL Configuration：

- Site URL：你的站点域名（例如 Netlify 域名）
- Redirect URLs 至少包含：
  - `https://你的域名/staff`
  - `https://你的域名/p/*`
  - 本地调试可加：`http://localhost:8888/staff`

## 2.4 前端配置

编辑 `site/config.js`：

- `SUPABASE_URL`
- `SUPABASE_ANON_KEY`

## 2.5 部署

推荐 Netlify（无构建静态站）：

- Publish directory: `site`
- Build command: 留空或 `echo 'no build'`

---

## 3. 教用户时可直接照着讲的“标准操作流程”（SOP）

这一段可作为你给用户的“逐步口播脚本”。

## 3.1 第一步：管理员登录并创建项目

1. 打开 `https://你的域名/staff`
2. 输入管理员邮箱，发送 magic link。
3. 去邮箱点击登录链接，返回系统后进入管理端。
4. 点击“创建项目”，填写：
   - 项目名称（示例：`IgAN 前瞻随访队列 2026`）
   - `center_code`（示例：`BJ01`）
   - module（示例：`IGAN`）

**示例**  
- 项目：`IgAN 前瞻随访队列 2026`  
- center_code：`BJ01`  
- module：`IGAN`

## 3.2 第二步：录入基线患者

在项目内新增受试者：

- 必填：`patient_code`（研究编号，如 `BJ01-0001`）
- 选填：疾病相关结构化字段（如 IGAN 可填 Oxford MEST-C）

**示例（IGAN）**
- patient_code：`BJ01-0001`
- M: `1`
- E: `0`
- S: `1`
- T: `0`
- C: `1`

> 培训时强调：patient_code 可以有规则，例如“中心代码-流水号”，便于人工核对。

## 3.3 第三步：生成随访链接并分发

1. 在患者行点击“生成随访 token”。
2. 系统会产生类似链接：`https://你的域名/p/AbCdEf123...`
3. 通过工作群/院内系统发送给负责随访录入的同事。

> 注意：token 链接具有访问权限含义，建议仅发给需要录入的成员。

## 3.4 第四步：随访人员录入访视（无需登录）

随访人员打开 `/p/<token>` 页面后填写核心项：

- 访视日期（date）
- 收缩压/舒张压（BP）
- Scr
- UPCR

**示例（第 1 次随访）**
- date：`2026-03-15`
- BP：`132/84`
- Scr：`1.42`
- UPCR：`0.88`

**示例（第 2 次随访）**
- date：`2026-06-15`
- BP：`128/80`
- Scr：`1.31`
- UPCR：`0.62`

## 3.5 第五步：管理员质控与导出

在 `/staff` 管理端进行：

1. 浏览项目数据，检查缺失值/异常值。
2. 点击“生成数据快照（Snapshot）”。
3. 点击“生成论文包（zip）”。
4. 下载后可在本地分析：
   - `pip install -r analysis/requirements.txt`
   - `python analysis/run_analysis.py`

---

## 4. 给用户的“实战场景”演示模板

你培训时可以按下面 15 分钟演示，效果最好。

## 场景：北京中心 1 名 IgAN 患者完成两次随访

### 4.1 创建项目
- 项目：`IgAN-BJ-2026`
- center_code：`BJ01`
- module：`IGAN`

### 4.2 建立患者基线
- patient_code：`BJ01-0123`
- MEST-C：`M1 E0 S1 T0 C1`

### 4.3 发送 token
- 链接：`/p/x7k29...`
- 发送对象：门诊随访护士 A

### 4.4 第一次录入
- 日期：`2026-01-10`
- BP：`136/86`
- Scr：`1.56`
- UPCR：`1.20`

### 4.5 第二次录入
- 日期：`2026-04-10`
- BP：`130/82`
- Scr：`1.43`
- UPCR：`0.79`

### 4.6 管理端核查
- 确认两次访视均存在。
- 无明显逻辑冲突（日期递增、数值合理）。
- 生成 snapshot，导出论文包。

---

## 5. 数据填写规范（建议打印给用户）

## 5.1 编号规范

- center_code：固定、短、唯一（例如 `BJ01`, `SH02`）
- patient_code：中心内唯一，建议格式：`中心-4位流水号`
  - 示例：`BJ01-0001`, `BJ01-0002`

## 5.2 时间规范

- 统一 `YYYY-MM-DD`
- 不要用 `2026/1/3` 或 `03-01-2026`

## 5.3 数值规范

- Scr、UPCR 使用统一单位（按项目 SOP）。
- 小数点统一半角（如 `1.42`）。
- 明显异常值先复核再提交。

## 5.4 缺失值处理

- 暂时缺失就留空，不要填 `0` 代替。
- 可在备注中标记“待补录”。

---

## 6. 常见问题（FAQ）与应对话术

## Q1：收到了登录邮件，点击后又回到登录页？
**原因**：Redirect URL 没配置好。  
**处理**：检查 Supabase Authentication 的 Site URL 和 Redirect URLs。

## Q2：同一患者怎么更新后续数据？
**答**：不用新建患者，直接使用该患者 token 新增后续访视记录。

## Q3：可以填写姓名或电话便于联系吗？
**答**：不可以。系统明确要求只使用研究编号，不录入 PII。

## Q4：发现 patient_code 输错了怎么办？
**建议流程**：
1. 由管理员核对原始记录；
2. 按中心 SOP 更正或作废错误记录；
3. 在变更日志或备注中留痕。

## Q5：论文复现时怎样保证“这版数据不可变”？
**答**：先生成 snapshot，再基于 snapshot 导出论文包并引用 snapshot ID。

---

## 7. 培训实施建议（给你作为讲师）

## 7.1 培训分层

- **管理员班（30~45 分钟）**：项目配置、基线录入、导出分析、快照管理。
- **录入员班（15~20 分钟）**：仅讲 `/p/<token>` 录入和数据规范。

## 7.2 培训材料建议

建议你准备 4 个文档：
1. 一页纸流程图（登录→建项目→建患者→发 token→录入→导出）
2. 字段字典（每个字段含义、单位、是否必填）
3. 常见错误清单（格式错误、单位混乱、重复编号）
4. 考核题（3 道场景题）

## 7.3 培训后验收（可直接使用）

- 验收题 1：新建 `BJ01` 中心项目并添加 1 名患者。
- 验收题 2：使用 token 完成 2 次随访录入。
- 验收题 3：管理员导出论文包并说出 snapshot 的用途。

---

## 8. 一段可以直接发给用户的“简版说明”

> 1）请先在管理端 `/staff` 用邮箱登录；2）管理员创建项目并录入患者研究编号（不要填姓名电话）；3）为每位患者生成随访链接 `/p/<token>` 发给随访人员；4）随访人员打开链接填写日期、血压、Scr、UPCR；5）管理员定期质控并导出数据包。系统仅用于科研登记，不用于临床诊疗决策。

---

## 9. 你可以怎样继续增强这份说明

如果你愿意，我下一步可以继续帮你产出：
- 面向“录入员”的超简版（1 页）
- 面向“PI”的质控版（含质控检查清单）
- 按你中心字段自定义的“带截图版操作手册”

