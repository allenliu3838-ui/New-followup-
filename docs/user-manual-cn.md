# KidneySphere AI · 随访系统 详细使用手册

> 版本：v2.0 | 适用人群：PI、CRC、录入员、随访护士
> 科研用途，不用于诊疗决策；禁止录入任何可识别个人信息（PII）。

---

## 目录

1. [核心概念（必读，3 分钟）](#1-核心概念)
2. [Token 是什么？怎么用？](#2-token-随访令牌)
3. [PII 是什么？为什么不能录入？](#3-pii-个人身份信息保护)
4. [第一次使用：管理员上线流程](#4-管理员上线流程)
5. [录入基线数据](#5-录入基线数据)
6. [录入随访记录（访视）](#6-录入随访记录)
7. [录入化验数据（字典化版）](#7-录入化验数据)
8. [录入用药 / 基因 / 终点事件](#8-其他数据录入)
9. [质控 Issue 系统：发现并解决数据问题](#9-质控-issue-系统)
10. [导出数据 & 生成论文包](#10-导出与论文包)
11. [常见错误 & 解决办法（FAQ）](#11-faq-常见错误)
12. [培训考核清单](#12-培训考核清单)

---

## 1. 核心概念

### 系统的三层结构

```
项目（Project）
  └── 患者（Patient）—— 用研究编号 patient_code 标识
        └── 随访记录 / 化验 / 用药 / 终点事件
```

**举例：**
- 项目：`IgAN 多中心随访研究 2024`
- 患者编号（patient_code）：`BJ01-2024-001`（北京01中心，2024年，第001号患者）
- 随访记录：该患者每3个月填写一次血压、血肌酐、尿蛋白

### 两个入口

| 入口 | 网址 | 用途 | 需要登录吗？ |
|---|---|---|---|
| **管理后台** | `/staff` | PI / CRC 管理项目、录入基线、导出数据 | ✅ 需要账号密码 |
| **患者随访页** | `/p/xxxxx` | 患者 / 护士 填写随访数据 | ❌ 不需要，用 Token 链接 |

### 多中心合并的关键

数据导出后，多中心合并时靠 **`center_code + patient_code`** 做唯一键。

> **正确例子：** 北京中心 `BJ01-2024-001`，上海中心 `SH02-2024-001` — 两者不会冲突
>
> **错误例子：** 所有中心都用 `001`、`002`……→ 合并时会乱掉，必须加中心前缀！

---

## 2. Token（随访令牌）

### Token 是什么？

**Token** 是一串随机的字母数字组合，长相类似：

```
a3f8b2c91d4e7f0612345678abcdef01
```

它充当患者随访页面的"**一次性钥匙**"：

- 包含 token 的链接格式：`https://你的域名/p/a3f8b2c91d4e7f0612345678abcdef01`
- 患者（或随访护士）打开这个链接，就能填写随访数据，**完全不需要账号**
- 每条 token 只绑定**一个患者**，不会串联
- Token 本身**不含任何个人信息**，泄露了也可以立即撤销

### Token 的四种状态

| 状态 | 图标颜色 | 含义 | 能否提交随访 |
|---|---|---|---|
| **有效** | 🟢 绿色 | 正常可用 | ✅ 能 |
| **已使用** | 🔵 蓝色 | 单次 token 已被使用 | ❌ 不能 |
| **已撤销** | 🔴 红色 | 管理员手动撤销 | ❌ 不能 |
| **已过期** | ⚫ 灰色 | 超过有效期 | ❌ 不能 |

### 两种类型

| 类型 | 适合场景 | 怎么设置 |
|---|---|---|
| **可多次使用**（默认） | 长期随访，患者每次复诊都用同一个链接 | 不勾选"单次使用" |
| **单次使用** | 一次性问卷、防止重复提交 | 勾选"单次使用" |

### 操作示例：生成一条随访链接

1. 在后台选中项目 → 找到患者列表 → 点该患者的「生成链接」
2. 系统自动填入患者编号，默认有效期 365 天
3. 如果是一次性调查，勾选「单次使用」
4. 点「生成随访链接」→ 复制链接发给患者或护士

**生成后你会看到：**
```
随访链接已生成 [有效]
有效期：365天后过期 · （可多次使用）

https://xxx.netlify.app/p/a3f8b2c91d...

[复制链接]  [打开随访页预览]  [立即撤销此 token]
```

### 撤销 Token（紧急情况）

如果链接发错患者、或患者不再参加研究，点「立即撤销此 token」，填写原因（如：`发错患者，重新生成`），链接立即失效，**已提交的数据不受影响**。

---

## 3. PII（个人身份信息）保护

### 什么是 PII？

PII（Personally Identifiable Information，个人可识别信息）是指任何能直接或间接识别出**具体自然人**的信息，包括：

| 类型 | 举例 | 系统是否拦截 |
|---|---|---|
| 手机号 | `13812345678` | ✅ 拦截 |
| 身份证号 | `110101199001011234` | ✅ 拦截 |
| 住院号/病案号 | `住院号:20240012345` | ✅ 拦截 |
| 病历号/MRN | `MRN: 789456` | ✅ 拦截 |
| 姓名 | `患者:张三` / `姓名：李四` | ✅ 拦截 |
| 邮箱 | `patient@qq.com` | ✅ 拦截 |
| 8位以上连续数字 | `20240012345678` | ✅ 拦截 |

### 为什么不能录入 PII？

1. **法规要求**：《个人信息保护法》《人类遗传资源管理条例》均要求科研数据去标识化
2. **伦理审查**：临床研究伦理批件通常明确要求数据不含 PII
3. **系统设计**：本系统的患者编号体系本身就是去标识化的，不需要姓名也能追踪患者

### 正确 vs 错误示例

❌ **错误（会被拦截）：**
```
备注：患者张三，住院号 20240001，电话 13812345678，依从性好
```

✅ **正确（系统接受）：**
```
备注：依从性好，血压控制满意，无明显不良反应
```

❌ **错误（会被拦截）：**
```
患者编号：身份证 110101199001011234
```

✅ **正确（系统接受）：**
```
患者编号：BJ01-2024-001
```

### 前后端双重拦截

- **前端**：填写时实时检测，输入框变红并提示
- **后端**：数据库触发器再次校验，命中即拒绝保存并返回 400 错误

即使绕过前端，数据库层也会阻止 PII 写入。

---

## 4. 管理员上线流程

### 第一步：注册账号

1. 打开 `/staff` 页面
2. 填写邮箱 + 密码（至少 8 位）
3. 点「注册账号」
4. 去邮箱点验证链接（如果系统要求邮件验证）

### 第二步：创建项目

1. 登录后在「项目管理」区域填写：
   - **项目名称**：如 `IgAN 多中心随访 2024`
   - **中心编码（center_code）**：如 `BJ01`（每个医院填不同的，这是多中心合并的关键）
   - **研究模块**：选 IGAN / LN / MN / KTX / GENERAL
2. 点「新建项目」

> **center_code 举例：**
> - 北京协和：`PUMCH-01`
> - 上海瑞金：`RJGH-01`
> - 同一医院多个科室可以：`PUMCH-01`、`PUMCH-02`

### 第三步：添加患者基线

见下一节「录入基线数据」。

### 第四步：生成随访链接

见「Token」章节。把链接发给患者或随访护士，让他们定期填写。

---

## 5. 录入基线数据

### 字段说明

| 字段 | 必填 | 填写规范 | 正确例子 | 错误例子 |
|---|---|---|---|---|
| **患者编号（patient_code）** | ✅ | 中心自定义，全项目唯一，必须加中心前缀 | `BJ01-2024-001` | `001`（无中心前缀会导致多中心合并冲突） |
| **性别** | 建议填 | M=男，F=女 | `M` | `男`（系统接受但建议用英文） |
| **出生年份** | 建议填 | 4 位数字，用于 eGFR 计算 | `1975` | `75`（系统会拒绝） |
| **基线日期** | ✅ | 活检日期或首次随访日期 | `2024-03-15` | `2024/3/15`（格式不同，用日期选择器） |
| **基线血肌酐（Scr）** | 建议填 | 单位：μmol/L | `120` | `1.35`（如果是 mg/dL 需换算：×88.4） |
| **基线 UPCR** | 建议填 | 单位：mg/g | `800` | `0.8`（如果是 g/g 需换算：×1000） |

### IgAN 专有字段：Oxford MEST-C 评分

仅当项目模块为 IGAN 时显示：

| 字段 | 含义 | 允许值 |
|---|---|---|
| M | 系膜细胞增殖 | 0 或 1 |
| E | 内皮细胞增殖 | 0 或 1 |
| S | 节段性硬化/粘连 | 0 或 1 |
| T | 肾小管萎缩/间质纤维化 | 0、1 或 2 |
| C | 新月体 | 0、1 或 2 |

**举例：**
- 活检提示 M1E0S1T1C0 → 填 M=1, E=0, S=1, T=1, C=0

### 常见问题

> **Q：患者编号填什么？**
> A：用你们中心自己的研究编号（不是住院号！），格式建议 `中心代码-年份-序号`，如 `BJ01-2024-001`。

> **Q：基线血肌酐单位是 mg/dL 怎么办？**
> A：乘以 88.4 换算为 μmol/L 后再填。例如 1.2 mg/dL → 106 μmol/L。

---

## 6. 录入随访记录

### 患者端（推荐方式）

管理员生成随访链接 → 发给患者或护士 → 患者打开链接填写 → 系统自动保存。

患者端填写的字段：

| 字段 | 说明 | 举例 |
|---|---|---|
| 随访日期 | 本次复诊日期 | `2024-06-15` |
| 收缩压（SBP） | 毫米汞柱 | `130` |
| 舒张压（DBP） | 毫米汞柱 | `80` |
| 血肌酐（Scr） | 单位 μmol/L | `115` |
| UPCR | 单位 mg/g | `650` |
| 备注 | 临床情况，**不得含 PII** | `血压控制满意，无水肿` |

**eGFR 自动计算：** 系统根据填入的血肌酐、患者性别（来自基线）、年龄（基于出生年）用 **CKD-EPI 2021 公式**自动计算 eGFR，无需手动填写。

### 自动质控检查

系统会在提交时自动检查：

| 检查项 | 触发条件 | 处理方式 |
|---|---|---|
| 日期冲突 | 随访日期早于基线日期 | ❌ 拒绝，必须改正 |
| 血压范围 | SBP/DBP 不在 30–300 mmHg | ❌ 拒绝 |
| 收缩压 < 舒张压 | 填反了 | ❌ 拒绝 |
| 血肌酐范围 | Scr 不在 10–5000 μmol/L | ❌ 拒绝 |
| PII 检测 | 备注含手机/身份证/住院号 | ❌ 拒绝 |
| 同日重复 | 同患者同日已有随访记录 | ⚠ 警告，需填原因才能保存 |
| 血肌酐跳变 | 与上次相比变化 >3 倍 | ⚠ 警告，需填原因 |

**举例（跳变警告）：**
```
血肌酐本次（450 μmol/L）与上次（2024-03-10，140 μmol/L）相差超过 3 倍，
请确认是否为急性肾损伤或测量误差。如确认无误，请填写「留痕原因」。
```
此时需要在「留痕原因」框填：`患者因感染住院出现 AKI，已与主治医生确认，值真实可靠`，然后才能保存。

---

## 7. 录入化验数据

### 新版字典化录入（v2 新功能）

v2 版本的化验录入不再是自由文本，而是：
1. 从下拉列表选化验项目（按模块分组）
2. 系统自动显示允许的单位（只能选，不能乱填）
3. 输入数值后，系统实时显示**标准值**（自动换算）

**这样做的好处：**
> 以前 A 中心填 `血肌酐 1.2 mg/dL`，B 中心填 `血肌酐 106 μmol/L`，合并时单位不一致 → 数据乱掉。
> 现在系统自动换算，两者都存为 `1.2 mg/dL` 或 `106 μmol/L`（统一标准单位），可直接合并分析。

### 常用化验项目 & 单位换算

| 项目（code） | 中文名 | 标准单位 | 常见录入单位 | 换算 |
|---|---|---|---|---|
| CREAT | 血肌酐 | mg/dL | μmol/L | ÷88.4 |
| UPCR | 尿蛋白/肌酐比 | g/g | mg/g | ÷1000 |
| HGB | 血红蛋白 | g/dL | g/L | ÷10 |
| ALB | 血清白蛋白 | g/dL | g/L | ÷10 |
| TCHOL | 总胆固醇 | mmol/L | mg/dL | ×0.02586 |

**录入示例：**

情景：血肌酐化验报告上写的是 88.4 μmol/L

1. 化验项目 → 选「血肌酐（CREAT）」
2. 单位 → 选「μmol/L」
3. 数值 → 填 `88.4`
4. 标准值框自动显示：`1.0000 mg/dL` ✅

情景：UPCR 化验结果 2000 mg/g

1. 化验项目 → 选「尿蛋白/肌酐比（UPCR）」
2. 单位 → 选「mg/g」
3. 数值 → 填 `2000`
4. 标准值框自动显示：`2.0000 g/g` ✅

### 同日重复化验

如果同一天同一化验项目已有记录，系统会提示：

```
该患者在 2024-06-15 已有一条 CREAT 记录（值：88.4 μmol/L）。
如确需保存，请在「留痕原因」中说明。
```

此时「留痕原因」框会出现，**必须填写**，例如：
```
第一次采血因溶血需复查，本次为确认值，已与检验科核实
```

---

## 8. 其他数据录入

### 用药记录

| 字段 | 说明 | 举例 |
|---|---|---|
| 药品名称 | 通用名（不要商品名） | `他克莫司` 而不是 `普乐可复` |
| 药品分类 | 治疗类别 | `免疫抑制剂` |
| 剂量 | 数字 + 单位 | `2mg/d` |
| 开始日期 | YYYY-MM-DD | `2024-01-15` |
| 结束日期 | 可为空（在用中） | `2024-06-30` 或留空 |

### 基因变异记录

| 字段 | 说明 | 举例 |
|---|---|---|
| 检测日期 | 基因检测报告日期 | `2024-02-20` |
| 基因名称 | HGNC 标准基因名 | `COL4A3` |
| 变异 | HGVS 格式（推荐） | `c.1684G>A` |
| 合子性 | 杂合/纯合 | `杂合` |
| 致病性分类 | 按 ACMG 5 级 | `致病性（Pathogenic）` |

### 终点事件

系统支持的标准终点类型：

| event_type | 含义 |
|---|---|
| `egfr_decline_40pct` | eGFR 较基线下降 ≥40% |
| `egfr_decline_57pct` | eGFR 较基线下降 ≥57% |
| `esrd` | 终末期肾病（需透析或移植） |
| `death` | 死亡 |
| `complete_remission` | 完全缓解 |
| `partial_remission` | 部分缓解 |
| `custom` | 自定义终点（在备注说明） |

---

## 9. 质控 Issue 系统

### Issue 是什么？

每当系统检测到数据问题（超范围、日期冲突、单位不对等），就会自动生成一个 **Issue（质控工单）**，状态从 `OPEN`（待处理）开始，直到问题解决才关闭。

类比：就像 GitHub Issues 管理 bug，这里的 Issue 管理数据质量问题。

### Issue 严重度

| 严重度 | 颜色 | 含义 | 影响 |
|---|---|---|---|
| **严重（critical）** | 🔴 红 | 数据无法用于分析 | 如：随访日期早于基线 |
| **警告（warning）** | 🟡 黄 | 数据可疑，需确认 | 如：血肌酐较上次增加3倍 |
| **提示（info）** | 🔵 蓝 | 建议补充 | 如：缺性别导致无法算eGFR |

### 四种 Issue 状态

```
OPEN（发现）→ IN_PROGRESS（处理中）→ RESOLVED（已解决）
                                    ↘ WONT_FIX（不修复，需填原因）
```

- **自动 RESOLVED**：修正数据后，系统自动关闭对应 Issue
- **手动 WONT_FIX**：无法修正（如历史数据），点「标记不修复」并填写原因

### 查看和处理 Issue

1. 后台「质控 Issue」区域显示汇总：未解决数量 + 按严重度分类
2. 点「查看所有 Issue」展开列表
3. 每条 Issue 显示：患者编号 / 记录类型 / 问题描述
4. 修正数据 → Issue 自动消失（RESOLVED）
5. 确实无法修正 → 点「标记不修复」→ 填理由（如：`历史数据，日期为估算值，已在伦理文件中说明`）

### 导出论文包时 Issue 状态会写入 qc_report.csv

投稿时审稿人可能要求提供数据质量报告，`qc_report.csv` 包含：
- 各中心缺失率（SBP / SCR / UPCR）
- 未解决 Issue 数量（按严重度）
- Issue 关闭率

**建议投稿前：** Issue 关闭率 ≥ 95%，critical 级别 = 0。

---

## 10. 导出与论文包

### 导出 CSV

点「导出基线数据」/ 「导出随访记录」等，下载对应的 CSV 文件（UTF-8 BOM 格式，Excel 可直接打开）。

**化验导出新增列（v2）：**
- `lab_test_code`：标准化编码（如 CREAT）
- `value_raw`：原始录入值
- `unit_symbol`：录入单位
- `value_standard`：换算后的标准值
- `standard_unit`：标准单位

### 生成论文包（zip）

点「一键生成论文包」，系统生成一个 zip 文件，包含：

```
paper_pack_项目名_日期.zip
├── data_dictionary.json      ← 字段定义、单位、eGFR 公式版本（NEW）
├── qc_report.csv             ← 数据质量报告（按中心）（NEW）
├── snapshot_manifest.json    ← 快照清单，用于论文引用（NEW）
├── qc_summary.json
├── EXPORT_METADATA.json
├── analysis/
│   ├── run_analysis.py       ← 可直接运行的 Python 分析脚本
│   ├── requirements.txt      ← Python 依赖
│   └── data/                 ← 所有 CSV 数据
│       ├── patients_baseline.csv
│       ├── visits_long.csv
│       ├── labs_long.csv
│       └── …
└── manuscript/
    ├── METHODS_AUTO_EN.md    ← 自动生成的 Methods 草稿（英文）
    └── README.md
```

### eGFR 公式版本说明

所有 eGFR 值旁边都有 `egfr_formula_version` 字段：

| 值 | 含义 |
|---|---|
| `CKD-EPI-2021-Cr` | 系统用 CKD-EPI 2021 公式自动计算（可引用：Inker et al., NEJM 2021） |
| `manual` | 研究者手动填写的值（来自实验室报告） |
| `missing_inputs` | 因缺少性别或出生年，无法计算 |

### 快照 ID 用于论文引用

生成快照后得到 `KS-2024-XXXXXXXX` 格式的 ID，可在论文 Methods 中引用：

> "The dataset was exported from KidneySphere AI Registry (Snapshot ID: KS-2024-A1B2C3D4, generated 2024-06-15) containing 156 patients and 843 follow-up visits."

这样，审稿人和合作者都能对应到同一版本的数据。

---

## 11. FAQ 常见错误

### Q1：提交随访时提示「token_expired」

**原因**：随访链接已超过有效期。

**解决**：管理员在后台重新为该患者生成链接，发送新链接给患者。

---

### Q2：提交时提示「token_already_used」

**原因**：这是一条「单次使用」token，已经被提交过一次了。

**解决**：管理员重新生成一条新 token（可以选多次使用或延长有效期）。

---

### Q3：备注保存失败，提示「pii_detected_blocked」

**原因**：备注中含有手机号/身份证/住院号/姓名等个人信息。

**解决**：删除备注中的个人信息，只保留临床描述。

✅ **正确示例：** `血压控制满意，依从性好，无不良反应`
❌ **错误示例：** `患者张三，13812345678，依从性好`

---

### Q4：保存化验记录时提示「unit_not_allowed」

**原因**：填写的单位不在该化验项目的允许列表中。

**解决**：从单位下拉列表选择（不要手动输入），系统会自动过滤允许的单位。

---

### Q5：随访日期保存失败，提示「DATE_CONFLICT」

**原因**：填写的随访日期早于该患者的基线日期。

**解决**：
1. 核对随访日期是否填错
2. 或核对基线日期是否填错
3. 如果是基线前的历史数据，需要修改基线日期

---

### Q6：eGFR 没有自动计算

**原因**：可能缺少患者性别或出生年份。

**解决**：在患者基线信息中补填性别和出生年，再次提交随访记录时 eGFR 会自动计算。

在质控 Issue 面板中会有一条「MISSING_EGFR_INPUTS」提示。

---

### Q7：血肌酐跳变警告，需要填「留痕原因」

**原因**：本次血肌酐与上次相差超过 3 倍，系统认为可能是异常。

**解决**：如果值是真实的（如患者住院发生 AKI），在「留痕原因」框填写：

> `患者2024-06-10因感染住院，出现急性肾损伤，值真实，已与主治医生电话确认`

然后点「保存」，系统会保存数据并记录你的解释，可供后续审计查阅。

---

### Q8：论文包下载后 CSV 打开乱码

**原因**：Excel 版本问题，UTF-8 BOM 有时不被识别。

**解决**：
1. 用 Excel「数据 → 从文本/CSV 导入」，选 UTF-8 编码
2. 或用 WPS 打开（中文版 WPS 通常可以直接识别）
3. 或用 Python/R 读取（推荐科研分析用途）

---

## 12. 培训考核清单

完成以下操作，即可认为培训通过：

- [ ] 完成账号注册和邮箱验证
- [ ] 创建一个测试项目，填写正确的 `center_code`
- [ ] 为测试项目添加 2 名患者（patient_code 带中心前缀）
- [ ] 成功生成随访链接（Token），区分单次/多次用途
- [ ] 打开随访链接，提交一条随访记录
- [ ] 验证：备注中输入手机号 → 前端出现红色提示 → 删除后保存成功
- [ ] 录入一条化验记录：选择 CREAT，填 88.4 μmol/L → 标准值自动显示 1.00 mg/dL
- [ ] 查看质控 Issue 面板，理解各种 Issue 的含义
- [ ] 生成论文包（zip），打开确认包含 `data_dictionary.json` 和 `qc_report.csv`
- [ ] 会撤销一条 Token（填写撤销原因）

> 培训建议：每位新录入员上岗前用测试项目完成以上全部操作，PI 复查后方可在正式项目中操作。
